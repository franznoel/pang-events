<!DOCTYPE HTML>
<html>
    <head>
        <title>pangEvents</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="styles.css" />
    </head>
    <body>
      <header>
        <div id="menu" class="top-bar">
          <div class="top-bar-left">
            <ul class="menu" data-dropdown-menu>
              <li class="menu-text"><a href="index.html">PangEvents</a></li>
            </ul>
          </div>
          <div class="top-bar-right">
            <ul id="loggedIn-menu" class="dropdown menu right-menu" data-dropdown-menu>
            <li class="has-submenu">
              <a href="#" class="button" id="displayedUser"></a>
              <ul class="submenu menu vertical displayedUser-dropdown" data-submenu>
                <li><a href="user-profile.html">View Profile</a></li>
                <li><a href="javascript:logout()">Logout</a></li>
              </ul>
              </li>
            </ul>
            <ul id="loggedOut-menu" class="menu right-menu">
              <li><a href="sign-up.html" class="button sign-up">Sign Up</a></li>
              <li><a href="sign-in.html" class="button sign-in">Sign In</a></li>
            </ul>
          </div>
        </div>
      </header>

      <div id="content" class="row">
        <div class="small-12 large-12 columns">
          <div id="event-add" class="large-12 columns">
            <div class="row">
              <div class="small-12 large-12 columns">
                <h2 class="page-title">Create Event</h2>
                <hr/>
              </div>
            </div>

            <div class="row">
              <div class="small-12 large-12 columns">
                <div id="errorMessage">
                </div>
              </div>
            </div>

            <form id="event-add-form" method="post">
              <div class="row">
                <div class="small-12 large-12 columns">
                  <label for="eventName">Event Name
                    <input type="text" id="eventName" name="eventName" placeholder="Event Name" required autofocus/>
                  </label>
                </div>
              </div>
              <div class="row">
                <div class="small-12 large-5 columns">
                  <label for="eventType">Event Type
                    <input type="text" list="eventTypeList" id="eventType" name="eventType" placeholder="Event Type" required />
                    <!--<input type="text" id="eventType" name="eventType" placeholder="Event Type" required />-->
                  </label>
                </div>
                <datalist id="eventTypeList">
                  <option value="Conference">Conference</option>
                  <option value="Seminar">Seminar</option>
                  <option value="Meetings">Meeting</option>
                  <option value="Team Building">Team Building</option>
                  <option value="Trade Show">Trade Show</option>
                  <option value="Business Dinner">Business Dinner</option>
                  <option value="Golf Event">Golf Event</option>
                  <option value="Press Conference">Press Conference</option>
                  <option value="Networking Event">Networking Event</option>
                  <option value="Incentive Travel">Incentive Travel</option>
                  <option value="Opening Ceremony">Opening Ceremony</option>
                  <option value="Product Launch">Product Launch</option>
                  <option value="Theme Party">Theme Party</option>
                  <option value="VIP Event">VIP Events</option>
                  <option value="Trade Fair">Trade Fair</option>
                  <option value="Shareholder Meeting">Shareholder Meeting</option>
                  <option value="Award Ceremony">Award Ceremony</option>
                  <option value="Incentive Event">Incentive Event</option>
                  <option value="Board Meeting">Board Meeting</option>
                  <option value="Executive Retreat">Executive Retreat</option>
                  <option value="Wedding">Wedding</option>
                  <option value="Birthday">Birthday</option>
                  <option value="Family Event">Family Event</option>
                </datalist>
                <div class="small-12 large-4 columns end">
                  <label for="eventHost">Host
                    <input type="text" id="eventHost" name="eventHost" placeholder="Host Name" required />
                  </label>
                </div>
              </div>
              <hr/>
              <div class="row">
                <div class="small-12 large-6 columns">
                  <fieldset class="fieldset">
                    <h4>Event Address</h4>
                    <label for="eventAddress">Address
                      <input type="text" id="eventAddress" name="eventAddress" placeholder="Address" required />
                    </label>
                    <div class="row">
                      <div class="small-12 large-5 columns">
                        <label for="eventAddressCity">City
                          <input type="text" id="eventAddressCity" name="eventAddressCity" placeholder="City" required />
                        </label>
                      </div>
                      <div class="small-12 large-2 columns">
                        <label for="eventAddressState">State
                          <select id="eventAddressState" name="eventAddressState" required>
                            <option value="">-- State --</option>
                            <option value="Alabama">AL</option>
                            <option value="Alaska">AK</option>
                            <option value="Arizona">AZ</option>
                            <option value="Arkansas">AR</option>
                            <option value="California">CA</option>
                            <option value="Colorado">CO</option>
                            <option value="Connecticut">CT</option>
                            <option value="Delaware">DE</option>
                            <option value="Florida">FL</option>
                            <option value="Georgia">GA</option>
                            <option value="Hawaii">HI</option>
                            <option value="Idaho">ID</option>
                            <option value="Illinois Indiana">IL</option>
                            <option value="Iowa">IO</option>
                            <option value="Kansas">KS</option>
                            <option value="Kentucky">KY</option>
                            <option value="Louisiana">LA</option>
                            <option value="Maine">ME</option>
                            <option value="Maryland">MD</option>
                            <option value="Massachusetts">MA</option>
                            <option value="Michigan">MI</option>
                            <option value="Minnesota">MN</option>
                            <option value="Mississippi">MS</option>
                            <option value="Missouri">MO</option>
                            <option value="Montana Nebraska">MO</option>
                            <option value="Nevada">NV</option>
                            <option value="New Hampshire">NH</option>
                            <option value="New Jersey">NJ</option>
                            <option value="New Mexico">NM</option>
                            <option value="New York">NY</option>
                            <option value="North Carolina">NC</option>
                            <option value="North Dakota">ND</option>
                            <option value="Ohio">OH</option>
                            <option value="Oklahoma">OK</option>
                            <option value="Oregon">OR</option>
                            <option value="Pennsylvania Rhode Island">PA</option>
                            <option value="South Carolina">SC</option>
                            <option value="South Dakota">SD</option>
                            <option value="Tennessee">TN</option>
                            <option value="Texas">TX</option>
                            <option value="Utah">UT</option>
                            <option value="Vermont">VT</option>
                            <option value="Virginia">VA</option>
                            <option value="Washington">WA</option>
                            <option value="West Virginia">WV</option>
                            <option value="Wisconsin">WI</option>
                            <option value="Wyoming">WY</option>
                          </select>
                        </label>
                      </div>
                      <div class="small-12 large-4 column">
                        <label for="eventAddressZip">Zip Code
                          <input type="text" id="eventAddressZip" name="eventAddressZip" placeholder="Zip Code" required>
                        </label>
                      </div>
                    </div>
                    <hr/>
                    <h4>Event Times</h4>
                    <label for="eventStartTime">Event Start
                      <input type="datetime-local" id="eventStartTime" name="eventStartTime" required />
                    </label>
                    <label for="eventEndTime">Event End
                      <input type="datetime-local" id="eventEndTime" name="eventEndTime" required />
                    </label>
                  </fieldset>
                </div>
                <div class="small-12 large-6 columns">
                  <label for="eventDescription">Description
                    <textarea id="eventDescription" name="eventDescription" rows="4" placeholder="Write something to your guests even just a short description." required></textarea>
                  </label>
                  <hr/>
                  <h5>Guests <span class="note">Make sure to Save Event to save guest list.</span></h5>
                  <input type="button" id="add-guest-modal-button" class="button primary tiny" value="Add Guest" data-open="add-guest-form" />
                  <input type="button" id="send-invitation" class="button secondary tiny" value="Send Invitation" />
                  <ul id="guest-list">
                  </ul>
                </div>
              </div>
              <input type="submit" name="submit" class="button" value="Save Event">
              <a href="index.html" class="button secondary">Cancel</a>
            </form>

            <div id="add-guest-form" class="reveal" data-reveal>
              <h3>Add a Guest</h3>
              <div id="event-guest-error" class="event-guest-error"></div>
              <form method="post">
                <label for="eventGuest">Event Guest
                  <input type="email" id="eventGuest" name="eventGuest" placeholder="Email Address" minlength="2" maxlength="254" required />
                </label>
                <input type="submit" id="add-guest" name="submit" class="button primary small" value="Add Guest"/>
                <a href="#guest-form-close" class="button secondary small" data-close>Close</a>
              </form>
              <button class="close-button" data-close aria-label="Close modal" type="button">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </div>
        <!-- #event-category -->
      </div>
      <script type="text/javascript" src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
      <script type="text/javascript" src="app.js"></script>
      <script type="text/javascript">
        // Set #eventType field
        $("#eventType").val(getParameterByName('eventType'));

        var ref = new Firebase("https://pang-events.firebaseio.com");
        var eventsRef = ref.child('events');
        var action = getParameterByName("action");

        var isNewUser = true;

        ref.onAuth(function(authData) {
          if (authData && isNewUser) {
            // save the user's profile into the database so we can list users,
            // use them in Security and Firebase Rules, and show profiles
            var userData = {
              provider: authData.provider,
              name: getName(authData)
            };

            // Get user data
            var userDataRef = ref.child("userData").child(authData.uid);
            userDataRef.on("value",function(snapshot,prevChildKey) {
              var userInfo = snapshot.val();
              try {
                $("#displayedUser").html(userInfo.firstname);
              } catch (e) {
                $("#displayUser").html(userData.name);
              }
            });

            // Show #loggedIn-menu
            $(".right-menu").hide();
            $("#loggedIn-menu").show();
            $("#displayedUser").html(userData.name);

          } else {
            // Show #loggedOut-menu
            $(".right-menu").hide();
            $("#loggedOut-menu").show();
            localStorage.setItem("referrer",window.location.href);
            window.location.replace("sign-in.html");
          }
        });

        prepareAddressValidation();

          // Change page title
          var pageTitle = action + " Event";
          $(".page-title").html(pageTitle);

          // Popupate event form
          if (action=="edit") {
            var key = getParameterByName('key');
            var eventsRef = ref.child("events").child(key);
            eventsRef.on("value",function(snapshot) {
              var e = snapshot.val();
              $("#eventName").val(e.eventName);
              $("#eventType").val(e.eventType);
              $("#eventHost").val(e.eventHost);
              $("#eventAddress").val(e.eventAddress);
              $("#eventDescription").val(e.eventDescription);
              $("#eventAddressCity").val(e.eventAddressCity);
              $("#eventAddressState").val(e.eventAddressState);
              $("#eventAddresCity").val(e.eventAddressCity);
              $("#eventAddressZip").val(e.eventAddressZip);
              $("#eventStartTime").val(e.eventStartTime);
              $("#eventEndTime").val(e.eventEndTime);
              var guestListHtml = getGuestListHtml(e.guests);
              $("#guest-list").html(guestListHtml);
            });
          }


          $(document).on("click","#add-guest",function(e) {
                e.preventDefault();
                var eventGuest = $("#eventGuest").val();
                var regexEmail = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

                console.log(regexEmail.test(eventGuest)==false);
                console.log(eventGuest!=="");

                if (regexEmail.test(eventGuest)==false) {
                  var message = createErrorMessage("error","Only an email address is allowed.");
                  $(".event-guest-error").html(message);
                } else if (eventGuest=="") {
                  var message = createErrorMessage("error","Guest list should not be blank.");
                  $(".event-guest-error").html(message);
                  // displayErrorMessage(message);
                } else {
                  eventGuest = (eventGuest).trim();
                  $("#guest-list").prepend("<li>"+ eventGuest +"</li>");
                  var message = createErrorMessage("success","Guest added.");
                  $(".event-guest-error").html(message);
                }

                $("#eventGuest").val(""); // Clear eventGuest field.
          });


          // Submit form
          $("#event-add-form").validate({
            onfocusout: false,
            onkeyup: false,
            rules: {
              eventName: {
                required: true,
              },
              eventType: {
                required: true,
              },
              eventHost: {
                required: true,
              },
              eventDescription: {
                required: true,
              },
              eventStartTime: {
                required: true,
              },
              eventEndTime: {
                required: true,
              },
              eventAddress: {
                required: true,
                minlength: 6,
                maxlength: 254,
              },
              eventAddressCity: {
                required: true,
                minlength: 2,
                maxlength: 254,
              },
              eventAddressState: {
                required: true,
              },
              eventAddressZip: {
                required: true,
                minlength: 5,
              }
            }, 
            messages: {
              eventName: {
                required: "Event Name is a required field.",
              },
              eventType: {
                required: "Event Type is a required field.",
              },
              eventHost: {
                required: "Event Host is a required field.",
              },
              eventDescription: {
                required: "Enter a message for your guests.",
              },
              eventStartTime: {
                required: "Declare when the event is going to start.",
              },
              eventEndTime: {
                required: "Declare when the event is going to end.",
              },
              eventAddress: {
                required: "Address is a required field.",
                minlength: "Address requires at least 6 characters."
              },
              eventAddressCity: {
                required: "City is a required field.",
                minlength: "City requires at least 2 letters."
              },
              eventAddressState: {
                required: "State is a required field.",
              },
              eventAddressZip: {
                required: "Zip Code is a required field.",
                minlength: "Zip Code should have minimum of 5 numbers."
              }
            },
            submitHandler: function() {
              var data = {
                eventName: $("#eventName").val(),
                eventType: $("#eventType").val(),
                eventHost: $("#eventHost").val(),
                eventDescription: $("#eventDescription").val(),
                eventStartTime: $("#eventStartTime").val(),
                eventEndTime: $("#eventEndTime").val(),
                eventAddress: $("#eventAddress").val(),
                eventAddressCity: $("#eventAddressCity").val(),
                eventAddressState: $("#eventAddressState").val(),
                eventAddressZip: $("#eventAddressZip").val(),
                guests: getGuests(),
              };

              // console.log(getGuests());

              // Create or update event
              var message = "";
              if (data.eventStartTime > data.eventEndTime) {
                // console.log("The event end time must be after the start time.");
                message = createErrorMessage('error','The event end time must be after the start time.');
                $("#errorMessage").html(message);
              } else {
                if (action=="create") {
                  console.log(eventsRef);
                  eventsRef.push().set(data,function(error) {
                    if (error) {
                      message = createErrorMessage("error","Errors found! " + error);
                    } else {
                      message = createErrorMessage("success","Successfully saved events.");
                    }
                    $("#errorMessage").html(message);
                    $("#errorMessage").show();
                  });
                } else if (action=="edit") {
                  var key = getParameterByName("key");
                  var eventRef = eventsRef.child(key);
                  eventsRef.on("value",function(snapshot) {
                    var e = snapshot.val();
                    // console.log(e.guests);
                  });
                  eventsRef.update(data,function(error) {
                    var message = "";
                    if (error) {
                      message = createErrorMessage("error","Errors found! " + error);
                    } else {
                      message = createErrorMessage("success","Successfully saved events.");
                    }
                    $("#errorMessage").html(message);
                    $("#errorMessage").show();
                  });
                }                
              }

              return false;
            },
            invalidHandler: function(event, validator) {
              var errors = validator.numberOfInvalids();
              if (errors) {
                var message = errors == 1 ? createErrorMessage("error","You missed 1 field. It has been highlighted") : createErrorMessage("error","You missed " + errors + " fields. They have been highlighted.");
                $("#errorMessage").html(message);
                $("#errorMessage").show();
              } else {
                $("#errorMessage").hide();
              }
            }
          });
      </script>

    </body>
</html>